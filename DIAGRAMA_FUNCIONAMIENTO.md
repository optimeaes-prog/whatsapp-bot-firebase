# ğŸ—ºï¸ DIAGRAMA COMPLETO: CÃ³mo Funciona la AplicaciÃ³n

## ğŸ“Š Vista General del Sistema

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         TU APLICACIÃ“N                               â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Frontend  â”‚         â”‚   Firebase   â”‚         â”‚   Backend   â”‚ â”‚
â”‚  â”‚   (React)   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”¤   Firestore  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  Functions  â”‚ â”‚
â”‚  â”‚             â”‚         â”‚  (Database)  â”‚         â”‚   (Node.js) â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                           â”‚         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                            â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                                       â”‚         â”‚
              â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”                        â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”‚
              â”‚   Whapi   â”‚                        â”‚    OpenAI    â”‚  â”‚
              â”‚ (WhatsApp)â”‚                        â”‚   (GPT-5.1)  â”‚  â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                    â”‚                                                â”‚
              â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”                                          â”‚
              â”‚  Usuario  â”‚                                          â”‚
              â”‚ WhatsApp  â”‚                                          â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
                                                                     â”‚
                        SERVICIOS EXTERNOS                           â”‚
                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ FLUJO 1: Crear Anuncio (GestiÃ³n Manual)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AGENTE       â”‚
â”‚ (Usuario)    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1. Abre navegador
       â”‚    localhost:5173/anuncios
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FRONTEND (React)                    â”‚
â”‚  PÃ¡gina: /anuncios                   â”‚
â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Formulario crear anuncio       â”‚ â”‚
â”‚  â”‚ - CÃ³digo (ej: VIL001)          â”‚ â”‚
â”‚  â”‚ - DescripciÃ³n                  â”‚ â”‚
â”‚  â”‚ - Enlace                       â”‚ â”‚
â”‚  â”‚ - Tipo: Venta/Alquiler         â”‚ â”‚
â”‚  â”‚ - CaracterÃ­sticas              â”‚ â”‚
â”‚  â”‚ - Informe rentabilidad         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚ 2. Click "Guardar"
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FIRESTORE                           â”‚
â”‚  ColecciÃ³n: anuncios/                â”‚
â”‚                                      â”‚
â”‚  {                                   â”‚
â”‚    anuncio: "VIL001",                â”‚
â”‚    descripcion: "Villa...",          â”‚
â”‚    tipoOperacion: "Venta",           â”‚
â”‚    caracteristicas: "...",           â”‚
â”‚    enlace: "https://...",            â”‚
â”‚    informeRentabilidad: "..."        â”‚
â”‚  }                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â”‚ 3. Anuncio guardado âœ…
            â–¼
       [Listo para usar]
```

---

## ğŸ”„ FLUJO 2: Crear Lead Manualmente (Iniciar ConversaciÃ³n)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AGENTE       â”‚
â”‚ (Usuario)    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 1. Lead interesado por Instagram/Facebook
       â”‚    TelÃ©fono: 34612345678
       â”‚    Anuncio: VIL001
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FRONTEND                            â”‚
â”‚  PÃ¡gina: /leads                      â”‚
â”‚  BotÃ³n: "Crear nuevo lead"           â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 2. POST /newLead
       â”‚    {telefono, anuncio}
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FIREBASE FUNCTION: newLead                                      â”‚
â”‚  (Backend - europe-west1)                                        â”‚
â”‚                                                                  â”‚
â”‚  PASO 1: Validar datos                                          â”‚
â”‚  â”œâ”€ Â¿Existe el anuncio VIL001 en Firestore?                    â”‚
â”‚  â””â”€ âœ… SÃ­ existe                                                 â”‚
â”‚                                                                  â”‚
â”‚  PASO 2: Detectar idioma                                        â”‚
â”‚  â”œâ”€ TelÃ©fono: 34612345678                                       â”‚
â”‚  â”œâ”€ CÃ³digo paÃ­s: 34 = EspaÃ±a                                    â”‚
â”‚  â””â”€ Idioma: EspaÃ±ol ğŸ‡ªğŸ‡¸                                          â”‚
â”‚                                                                  â”‚
â”‚  PASO 3: Preparar mensajes iniciales                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ Mensaje 1:                                            â”‚      â”‚
â”‚  â”‚ "Hola, soy el colaborador virtual de Paco           â”‚      â”‚
â”‚  â”‚  Granados, un placer atenderte.                      â”‚      â”‚
â”‚  â”‚                                                       â”‚      â”‚
â”‚  â”‚  No olvides seguirme, encontrarÃ¡s todo tipo de      â”‚      â”‚
â”‚  â”‚  oportunidades inmobiliarias en este perfil ğŸ‘‡       â”‚      â”‚
â”‚  â”‚                                                       â”‚      â”‚
â”‚  â”‚  [Instagram URL]"                                     â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ Mensaje 2:                                            â”‚      â”‚
â”‚  â”‚ "Te has interesado en esta vivienda en venta ğŸ‘‡      â”‚      â”‚
â”‚  â”‚                                                       â”‚      â”‚
â”‚  â”‚  [Enlace anuncio]                                    â”‚      â”‚
â”‚  â”‚                                                       â”‚      â”‚
â”‚  â”‚  Por confirmar, Â¿has visto las caracterÃ­sticas?     â”‚      â”‚
â”‚  â”‚                                                       â”‚      â”‚
â”‚  â”‚  â€¢ 4 dormitorios, 3 baÃ±os                           â”‚      â”‚
â”‚  â”‚  â€¢ 250mÂ² construidos                                 â”‚      â”‚
â”‚  â”‚  â€¢ Piscina privada                                   â”‚      â”‚
â”‚  â”‚  â€¢ ..."                                              â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                  â”‚
â”‚  PASO 4: Enviar mensajes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â”‚
                                              â–¼
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚  WHAPI.CLOUD    â”‚
                                    â”‚  (API WhatsApp) â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                             â”‚
                                             â”‚ EnvÃ­a via WhatsApp
                                             â–¼
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚  ğŸ“± USUARIO     â”‚
                                    â”‚    WhatsApp     â”‚
                                    â”‚  34612345678    â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                             â”‚
                                             â”‚ Recibe 2 mensajes
                                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  USUARIO VE:                                               â”‚
â”‚                                                            â”‚
â”‚  ğŸ’¬ Mensaje 1: PresentaciÃ³n + Instagram                   â”‚
â”‚  ğŸ’¬ Mensaje 2: Anuncio + CaracterÃ­sticas                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ Mientras tanto...
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FIRESTORE - Datos guardados:        â”‚
â”‚                                      â”‚
â”‚  1ï¸âƒ£ leads/                           â”‚
â”‚     {                                â”‚
â”‚       telefono: "34612345678",       â”‚
â”‚       anuncio: "VIL001",             â”‚
â”‚       chatId: "34612345678@c.us",    â”‚
â”‚       tipoOperacion: "Venta"         â”‚
â”‚     }                                â”‚
â”‚                                      â”‚
â”‚  2ï¸âƒ£ conversaciones/                  â”‚
â”‚     34612345678@c.us/                â”‚
â”‚     {                                â”‚
â”‚       telefono: "34612345678",       â”‚
â”‚       anuncio: "VIL001",             â”‚
â”‚       history: [                     â”‚
â”‚         {role: "assistant",          â”‚
â”‚          text: "Hola, soy..."},      â”‚
â”‚         {role: "assistant",          â”‚
â”‚          text: "Te has interesado..."â”‚
â”‚       ],                             â”‚
â”‚       isFinished: false              â”‚
â”‚     }                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ âœ… Lead creado y conversaciÃ³n iniciada
       â–¼
   [Esperando respuesta del usuario]
```

---

## ğŸ”„ FLUJO 3: Usuario Responde (ConversaciÃ³n AutomÃ¡tica)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“± USUARIO     â”‚
â”‚    WhatsApp     â”‚
â”‚  34612345678    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Usuario escribe:
         â”‚ "Hola, me interesa. Â¿CuÃ¡l es el precio?"
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WHAPI.CLOUD                        â”‚
â”‚  (Recibe mensaje de WhatsApp)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Webhook configurado:
         â”‚ POST a tu funciÃ³n webhook
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FIREBASE FUNCTION: webhook                                           â”‚
â”‚  (Backend - europe-west1)                                             â”‚
â”‚                                                                       â”‚
â”‚  PASO 1: Recibir mensaje                                            â”‚
â”‚  â”œâ”€ De: 34612345678                                                 â”‚
â”‚  â”œâ”€ ChatId: 34612345678@c.us                                        â”‚
â”‚  â”œâ”€ Texto: "Hola, me interesa. Â¿CuÃ¡l es el precio?"                â”‚
â”‚  â””â”€ Timestamp: [fecha/hora]                                         â”‚
â”‚                                                                       â”‚
â”‚  PASO 2: Buscar conversaciÃ³n en Firestore â”€â”€â”€â”€â”€â”€â”                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                   â”‚
                                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FIRESTORE: conversaciones/34612345678@c.us                          â”‚
â”‚                                                                      â”‚
â”‚  {                                                                   â”‚
â”‚    telefono: "34612345678",                                          â”‚
â”‚    anuncio: "VIL001",                                                â”‚
â”‚    tipoOperacion: "Venta",                                           â”‚
â”‚    descripcion: "Villa moderna...",                                  â”‚
â”‚    enlace: "https://...",                                            â”‚
â”‚    caracteristicas: "4 dorm...",                                     â”‚
â”‚    history: [                                                        â”‚
â”‚      {role: "assistant", text: "Hola, soy..."},                     â”‚
â”‚      {role: "assistant", text: "Te has interesado..."}              â”‚
â”‚    ]                                                                 â”‚
â”‚  }                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                   â”‚
                                                   â”‚ âœ… ConversaciÃ³n encontrada
                                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FUNCTION: webhook (continÃºa)                                         â”‚
â”‚                                                                       â”‚
â”‚  PASO 3: Agregar mensaje del usuario al historial                   â”‚
â”‚  history.push({                                                      â”‚
â”‚    role: "user",                                                     â”‚
â”‚    text: "Hola, me interesa. Â¿CuÃ¡l es el precio?",                  â”‚
â”‚    timestamp: Date.now()                                             â”‚
â”‚  })                                                                  â”‚
â”‚                                                                       â”‚
â”‚  PASO 4: Intentar extraer nombre â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                    â”‚
                                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  OPENAI API: Extraer nombre                                        â”‚
â”‚                                                                    â”‚
â”‚  Prompt: "Identifica el nombre del cliente en esta conversaciÃ³n"  â”‚
â”‚  Input: [historial de mensajes]                                   â”‚
â”‚  Output: "UNKNOWN" (aÃºn no se ha presentado)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                 â”‚
                                                 â”‚ Nombre no detectado
                                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FUNCTION: webhook (continÃºa)                                         â”‚
â”‚                                                                       â”‚
â”‚  PASO 5: Obtener estilo de bot activo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                    â”‚
                                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FIRESTORE: botConfig/config                                         â”‚
â”‚                                                                      â”‚
â”‚  {                                                                   â”‚
â”‚    activeStyleId: "directo",                                         â”‚
â”‚    styles: [                                                         â”‚
â”‚      {                                                               â”‚
â”‚        id: "directo",                                                â”‚
â”‚        name: "Directo y Eficiente",                                  â”‚
â”‚        promptModifier: "Mensajes CORTOS y DIRECTOS..."              â”‚
â”‚      },                                                              â”‚
â”‚      ...otros estilos                                                â”‚
â”‚    ]                                                                 â”‚
â”‚  }                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                   â”‚
                                                   â”‚ âœ… Estilo: "directo"
                                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FUNCTION: webhook (continÃºa)                                         â”‚
â”‚                                                                       â”‚
â”‚  PASO 6: Generar respuesta con IA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                    â”‚
                                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  OPENAI API: Generar respuesta                                         â”‚
â”‚  Modelo: gpt-5.1                                                       â”‚
â”‚                                                                        â”‚
â”‚  INSTRUCTIONS (Prompt del sistema):                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Eres un asistente virtual de un Agente Inmobiliario.        â”‚    â”‚
â”‚  â”‚ Cualificas leads de forma DIRECTA y EFICIENTE.              â”‚    â”‚
â”‚  â”‚                                                               â”‚    â”‚
â”‚  â”‚ ESTILO: Directo y Eficiente                                 â”‚    â”‚
â”‚  â”‚ - Mensajes CORTOS y DIRECTOS                                â”‚    â”‚
â”‚  â”‚ - NO repitas informaciÃ³n                                     â”‚    â”‚
â”‚  â”‚ - AGRUPA preguntas                                           â”‚    â”‚
â”‚  â”‚                                                               â”‚    â”‚
â”‚  â”‚ FLUJO PARA "Venta":                                          â”‚    â”‚
â”‚  â”‚ 1. Pregunta nombre si no se presentÃ³                        â”‚    â”‚
â”‚  â”‚ 2. Confirma caracterÃ­sticas                                  â”‚    â”‚
â”‚  â”‚ 3. Pregunta mÃ©todo de pago (contado/hipoteca)              â”‚    â”‚
â”‚  â”‚ 4. Pregunta disponibilidad para visita                      â”‚    â”‚
â”‚  â”‚ 5. Cierre con [LEAD_CUALIFICADO]                           â”‚    â”‚
â”‚  â”‚                                                               â”‚    â”‚
â”‚  â”‚ Datos del anuncio:                                           â”‚    â”‚
â”‚  â”‚ - Enlace: https://...                                        â”‚    â”‚
â”‚  â”‚ - CaracterÃ­sticas: 4 dorm, 250mÂ², piscina...               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                        â”‚
â”‚  INPUT (Historial):                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ [ASISTENTE]: Hola, soy el colaborador virtual...            â”‚    â”‚
â”‚  â”‚ [ASISTENTE]: Te has interesado en esta vivienda...          â”‚    â”‚
â”‚  â”‚ [USUARIO]: Hola, me interesa. Â¿CuÃ¡l es el precio?           â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                        â”‚
â”‚  OUTPUT (Respuesta generada):                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ "El precio estÃ¡ en el enlace que te enviÃ©. Te encajan las   â”‚    â”‚
â”‚  â”‚  caracterÃ­sticas? Para avanzar, Â¿con quiÃ©n hablo?"          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                 â”‚
                                                 â”‚ âœ… Respuesta lista
                                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FUNCTION: webhook (continÃºa)                                         â”‚
â”‚                                                                       â”‚
â”‚  PASO 7: Verificar si hay marcadores                                 â”‚
â”‚  â”œâ”€ Â¿Contiene [LEAD_CUALIFICADO]? âŒ No                              â”‚
â”‚  â”œâ”€ Â¿Contiene [LEAD_NO_INTERESADO]? âŒ No                            â”‚
â”‚  â””â”€ ConversaciÃ³n continÃºa                                            â”‚
â”‚                                                                       â”‚
â”‚  PASO 8: Enviar respuesta â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                 â”‚
                                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WHAPI.CLOUD                                                    â”‚
â”‚  POST /messages/text                                            â”‚
â”‚                                                                 â”‚
â”‚  {                                                              â”‚
â”‚    to: "34612345678",                                           â”‚
â”‚    body: "El precio estÃ¡ en el enlace que te enviÃ©..."         â”‚
â”‚  }                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â”‚ EnvÃ­a via WhatsApp
                                   â–¼
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚  ğŸ“± USUARIO     â”‚
                          â”‚    WhatsApp     â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â”‚ Recibe respuesta del bot
                                   â–¼
         [Usuario ve: "El precio estÃ¡ en el enlace que te enviÃ©..."]
                                   â”‚
                                   â”‚ Mientras tanto...
                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FIRESTORE: Actualizar conversaciÃ³n                             â”‚
â”‚                                                                  â”‚
â”‚  conversaciones/34612345678@c.us/                               â”‚
â”‚  {                                                               â”‚
â”‚    ...                                                           â”‚
â”‚    history: [                                                    â”‚
â”‚      {role: "assistant", text: "Hola, soy..."},                â”‚
â”‚      {role: "assistant", text: "Te has interesado..."},         â”‚
â”‚      {role: "user", text: "Hola, me interesa..."},  â† NUEVO    â”‚
â”‚      {role: "assistant", text: "El precio estÃ¡..."}  â† NUEVO   â”‚
â”‚    ],                                                            â”‚
â”‚    numeroMensajes: 4,                                            â”‚
â”‚    ultimoMensaje: [timestamp],                                   â”‚
â”‚    isFinished: false                                             â”‚
â”‚  }                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ âœ… ConversaciÃ³n guardada
       â–¼
   [Esperando siguiente mensaje del usuario...]
```

---

## ğŸ”„ FLUJO 4: Lead se Cualifica (Final de ConversaciÃ³n)

```
[... despuÃ©s de varios mensajes ...]

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“± USUARIO     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Usuario responde:
         â”‚ "Soy MarÃ­a. Me interesa comprar al contado.
         â”‚  Puedo ir maÃ±anas. Â¿CuÃ¡ndo puedo visitar?"
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WHAPI â†’ WEBHOOK â†’ OPENAI           â”‚
â”‚  (mismo flujo anterior)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  OPENAI: Analiza el historial                                     â”‚
â”‚                                                                    â”‚
â”‚  Detecta:                                                          â”‚
â”‚  âœ… Nombre: "MarÃ­a"                                                â”‚
â”‚  âœ… MÃ©todo de pago: "Al contado"                                   â”‚
â”‚  âœ… Disponibilidad: "MaÃ±anas"                                      â”‚
â”‚  âœ… Interesado: SÃ­                                                 â”‚
â”‚                                                                    â”‚
â”‚  ConclusiÃ³n: LEAD CUALIFICADO âœ…                                   â”‚
â”‚                                                                    â”‚
â”‚  OUTPUT:                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ "Perfecto MarÃ­a! El comercial te llamarÃ¡ para           â”‚    â”‚
â”‚  â”‚  confirmar la visita. Â¡Gracias por tu interÃ©s!"         â”‚    â”‚
â”‚  â”‚                                                           â”‚    â”‚
â”‚  â”‚  [LEAD_CUALIFICADO]"                                     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FUNCTION: webhook (continÃºa)                                         â”‚
â”‚                                                                       â”‚
â”‚  PASO 1: Detecta marcador [LEAD_CUALIFICADO] âœ…                      â”‚
â”‚                                                                       â”‚
â”‚  PASO 2: Limpia mensaje (quita marcador)                            â”‚
â”‚  Mensaje final: "Perfecto MarÃ­a! El comercial te llamarÃ¡..."        â”‚
â”‚                                                                       â”‚
â”‚  PASO 3: EnvÃ­a respuesta al usuario â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚                                                â”‚                     â”‚
â”‚  PASO 4: Generar resumen del lead â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”˜
                                                 â”‚                 â”‚
                                                 â–¼                 â–¼
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚ WHAPI        â”‚    â”‚ OPENAI           â”‚
                                    â”‚ EnvÃ­a mensajeâ”‚    â”‚ Resumir lead     â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                             â”‚                   â”‚
                                             â–¼                   â”‚
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
                                    â”‚  ğŸ“± MarÃ­a       â”‚         â”‚
                                    â”‚  (Usuario)      â”‚         â”‚
                                    â”‚  Recibe mensaje â”‚         â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
                                                                 â”‚
                                                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  OPENAI: Analizar conversaciÃ³n completa                                â”‚
â”‚                                                                        â”‚
â”‚  Prompt: "Extrae informaciÃ³n del lead"                                â”‚
â”‚  Input: [Todo el historial de mensajes]                               â”‚
â”‚                                                                        â”‚
â”‚  OUTPUT (JSON):                                                        â”‚
â”‚  {                                                                     â”‚
â”‚    "nombre": "MarÃ­a",                                                  â”‚
â”‚    "formaPago": "Al contado",                                          â”‚
â”‚    "disponibilidadVisita": "MaÃ±anas",                                  â”‚
â”‚    "ingresos": "",                                                     â”‚
â”‚    "notas": "Muy interesada, rÃ¡pida respuesta"                        â”‚
â”‚  }                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                 â”‚
                                                 â”‚ âœ… Resumen generado
                                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FUNCTION: webhook (continÃºa)                                         â”‚
â”‚                                                                       â”‚
â”‚  PASO 5: Construir mensaje de notificaciÃ³n                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Lead cualificado âœ…                                           â”‚   â”‚
â”‚  â”‚ TelÃ©fono: 34612345678                                         â”‚   â”‚
â”‚  â”‚ Nombre: MarÃ­a                                                 â”‚   â”‚
â”‚  â”‚ Propiedad: Villa moderna en Marbella con vistas al mar       â”‚   â”‚
â”‚  â”‚ OperaciÃ³n: Venta                                              â”‚   â”‚
â”‚  â”‚ Forma de pago: Al contado                                     â”‚   â”‚
â”‚  â”‚ Ingresos: Sin datos                                           â”‚   â”‚
â”‚  â”‚ Disponibilidad visita: MaÃ±anas                                â”‚   â”‚
â”‚  â”‚ Notas: Muy interesada, rÃ¡pida respuesta                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                       â”‚
â”‚  PASO 6: Enviar notificaciÃ³n al agente â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚                                                â”‚                      â”‚
â”‚  PASO 7: Guardar en Firestore â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”˜
                                                â”‚                 â”‚
                                                â–¼                 â–¼
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚ WHAPI        â”‚  â”‚ FIRESTORE        â”‚
                                    â”‚ NotificaciÃ³n â”‚  â”‚ Guardar datos    â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚                   â”‚
                                           â–¼                   â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚  ğŸ“± AGENTE           â”‚  â”‚ cualificados/      â”‚
                            â”‚  (34669354177)       â”‚  â”‚ [nuevo documento]  â”‚
                            â”‚                      â”‚  â”‚                    â”‚
                            â”‚ Recibe notificaciÃ³n: â”‚  â”‚ {                  â”‚
                            â”‚ "Lead cualificado âœ…"â”‚  â”‚   telefono: "...", â”‚
                            â”‚ "TelÃ©fono: ..."      â”‚  â”‚   nombre: "MarÃ­a", â”‚
                            â”‚ "Nombre: MarÃ­a"      â”‚  â”‚   anuncio: "VIL001"â”‚
                            â”‚ ...                  â”‚  â”‚   resumen: "...",  â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   cualificado: trueâ”‚
                                                      â”‚ }                  â”‚
                                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                               â”‚
                                                               â–¼
                                                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                 â”‚ conversaciones/          â”‚
                                                 â”‚ 34612345678@c.us         â”‚
                                                 â”‚                          â”‚
                                                 â”‚ {                        â”‚
                                                 â”‚   ...history completo    â”‚
                                                 â”‚   qualificationStatus:   â”‚
                                                 â”‚     true,                â”‚
                                                 â”‚   isFinished: true âœ…    â”‚
                                                 â”‚ }                        â”‚
                                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                               â”‚
                                                               â”‚
                                                               â–¼
                                                   [ConversaciÃ³n terminada]
                                                   [Lead cualificado]
                                                   [Agente notificado]
```

---

## ğŸ“Š RESUMEN DE COMPONENTES

### ğŸ¨ FRONTEND (React + Vite)
```
PÃ¡ginas disponibles:
â”œâ”€â”€ /              â†’ Dashboard (estadÃ­sticas)
â”œâ”€â”€ /anuncios      â†’ CRUD de anuncios
â”œâ”€â”€ /leads         â†’ GestiÃ³n de leads
â”œâ”€â”€ /conversaciones â†’ Ver historial de chats
â”œâ”€â”€ /cualificados  â†’ Leads cualificados
â””â”€â”€ /configuracion â†’ Cambiar estilo del bot
```

### ğŸ”¥ FIRESTORE (Base de Datos)
```
Colecciones:
â”œâ”€â”€ anuncios/          â†’ 5 propiedades inmobiliarias
â”œâ”€â”€ leads/             â†’ Leads registrados (con chatId)
â”œâ”€â”€ conversaciones/    â†’ Historial completo de chats
â”œâ”€â”€ cualificados/      â†’ Leads cualificados con resÃºmenes
â””â”€â”€ botConfig/         â†’ ConfiguraciÃ³n (4 estilos disponibles)
```

### âš¡ FIREBASE FUNCTIONS (Backend)
```
Functions desplegadas en europe-west1:
â”œâ”€â”€ webhook    â†’ Recibe mensajes de WhatsApp (webhook de Whapi)
â”œâ”€â”€ newLead    â†’ Crea lead y envÃ­a mensajes iniciales
â””â”€â”€ healthz    â†’ Health check
```

### ğŸ¤– INTEGRACIONES EXTERNAS
```
â”œâ”€â”€ Whapi.cloud    â†’ API de WhatsApp
â”‚   â””â”€â”€ EnvÃ­a/recibe mensajes
â”‚
â”œâ”€â”€ OpenAI GPT-5.1 â†’ Inteligencia Artificial
â”‚   â”œâ”€â”€ Genera respuestas contextuales
â”‚   â”œâ”€â”€ Extrae informaciÃ³n (nombre, datos)
â”‚   â””â”€â”€ Resume conversaciones
â”‚
â””â”€â”€ Firestore      â†’ Base de datos en tiempo real
    â””â”€â”€ Almacena todo el estado
```

---

## ğŸ”„ ESTADOS DE UNA CONVERSACIÃ“N

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  INICIADA   â”‚  â† Lead creado, mensajes iniciales enviados
â”‚  (pending)  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ Usuario responde
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EN PROGRESO â”‚  â† Bot conversando, recopilando informaciÃ³n
â”‚ (active)    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ Bot recopilÃ³ toda la info
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FINALIZADA  â”‚  â† Marcada con [LEAD_CUALIFICADO] o
â”‚ (finished)  â”‚    [LEAD_NO_INTERESADO]
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€ Si cualificado â”€â–º Guardado en cualificados/
       â”‚                    NotificaciÃ³n al agente
       â”‚
       â””â”€ Si no interesado â–º Solo se marca como finished
```

---

## ğŸ¯ DATOS QUE RECOPILA EL BOT

### Para VENTA:
```
âœ“ Nombre del cliente
âœ“ ConfirmaciÃ³n de caracterÃ­sticas
âœ“ MÃ©todo de pago (contado/hipoteca)
âœ“ Si hipoteca: Â¿ya aprobada?
âœ“ Disponibilidad para visita
âœ“ Notas adicionales
```

### Para ALQUILER:
```
âœ“ Nombre del cliente
âœ“ NÃºmero de personas
âœ“ Ingresos netos mensuales
âœ“ Fecha de entrada deseada
âœ“ Mascotas (sÃ­/no/cuÃ¡les)
âœ“ Disponibilidad para visita
âœ“ Notas adicionales
```

---

## ğŸ¨ ESTILOS DE CONVERSACIÃ“N DISPONIBLES

```
1. Directo y Eficiente (activo por defecto)
   â””â”€ Mensajes cortos, agrupa preguntas, sin relleno

2. Amigable y Cercano
   â””â”€ Tono cÃ¡lido, emojis, preguntas de una en una

3. Formal y Profesional
   â””â”€ Tratamiento de usted, lenguaje corporativo

4. Ultra Conciso
   â””â”€ Estilo telegrama, mÃ­nimo de palabras
```

**Cambias el estilo en:** `/configuracion` en el frontend  
**Efecto:** Se aplica inmediatamente a nuevas conversaciones

---

## ğŸ’° FLUJO DE COSTOS (Aproximado)

```
Por cada lead cualificado:

WhatsApp (Whapi)
â”œâ”€ 2 mensajes iniciales
â”œâ”€ ~10 mensajes de conversaciÃ³n
â””â”€ ~$0.01 - $0.05 segÃºn plan

OpenAI (GPT-5.1)
â”œâ”€ ~15 llamadas a la API
â”‚  â”œâ”€ Generar respuestas (10x)
â”‚  â”œâ”€ Extraer nombre (2x)
â”‚  â”œâ”€ Resumir lead (1x)
â”‚  â””â”€ Traducir (si es necesario) (2x)
â””â”€ ~$0.01 - $0.05 por lead

Firebase
â”œâ”€ Functions: Gratis (primeras 2M invocaciones/mes)
â”œâ”€ Firestore: Gratis (plan Spark para bajo volumen)
â””â”€ Hosting: Gratis

TOTAL POR LEAD CUALIFICADO: ~$0.02 - $0.10
```

---

Esta es la arquitectura completa de tu aplicaciÃ³n. Â¿Necesitas que profundice en alguna parte especÃ­fica?
